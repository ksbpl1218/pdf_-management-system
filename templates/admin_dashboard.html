<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PDF Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .header { background-color: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .logout-btn { background-color: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background-color: #c0392b; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .tabs { display: flex; background: white; border-radius: 8px 8px 0 0; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab { padding: 1rem 2rem; background-color: #ecf0f1; border: none; cursor: pointer; font-size: 1rem; }
        .tab.active, .tab:hover { background-color: #3498db; color: white; }
        .tab-content { display: none; background: white; padding: 2rem; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .actions { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-warning:hover { background-color: #e67e22; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background-color: #34495e; color: white; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 2rem; border-radius: 8px; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .status { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .status.active { background-color: #d5e8d4; color: #27ae60; }
        .status.inactive { background-color: #f8d7da; color: #e74c3c; }
        .selection-info { background-color: #e3f2fd; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; }
        .error-message { background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .success-message { background-color: #d1ecf1; color: #0c5460; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .files-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; }
        .files-modal-content { background: white; margin: 3% auto; padding: 2rem; border-radius: 8px; max-width: 800px; max-height: 85vh; overflow-y: auto; }
        .loading { text-align: center; padding: 2rem; color: #666; }
    </style>
</head>
<body>
    <script>
        if (!localStorage.getItem('adminToken')) {
            window.location.href = '/login.html';
            document.body.style.display = 'none';
        }
    </script>

    <div class="header">
        <h1>PDF Management System - Admin Dashboard</h1>
        <div><button class="logout-btn" onclick="logout()">Logout</button></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('users')">Users</button>
            <button class="tab" onclick="showTab('folders')">Folders</button>
            <button class="tab" onclick="showTab('files')">Files</button>
        </div>

        <div id="users" class="tab-content active">
            <h2>User Management</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="showModal('userModal')">Add User</button>
                <button class="btn btn-danger" onclick="deleteSelectedUsers()">Delete Selected</button>
            </div>
            <div id="userSelectionInfo" class="selection-info" style="display:none;"><span id="userSelectionCount">0</span> selected</div>
            <table class="table">
                <thead><tr><th><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()"></th><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="userTableBody"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="folders" class="tab-content">
            <h2>Folder Management</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="showModal('folderModal')">Create Folder</button>
                <button class="btn btn-danger" onclick="deleteSelectedFolders()">Delete Selected</button>
            </div>
            <div id="folderSelectionInfo" class="selection-info" style="display:none;"><span id="folderSelectionCount">0</span> selected</div>
            <table class="table">
                <thead><tr><th><input type="checkbox" id="selectAllFolders" onchange="toggleSelectAllFolders()"></th><th>Name</th><th>Path</th><th>Permission</th><th>Actions</th></tr></thead>
                <tbody id="folderTableBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="files" class="tab-content">
            <h2>File Management</h2>
            <div class="actions"><button class="btn btn-danger" onclick="deleteSelectedFiles()">Delete Selected</button></div>
            <div id="fileSelectionInfo" class="selection-info" style="display:none;"><span id="fileSelectionCount">0</span> selected</div>
            <table class="table">
                <thead><tr><th><input type="checkbox" id="selectAllFiles" onchange="toggleSelectAllFiles()"></th><th>Name</th><th>Folder</th><th>Size</th><th>Actions</th></tr></thead>
                <tbody id="fileTableBody"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="userModalTitle">Add User</h3><button class="close" onclick="hideModal('userModal')">&times;</button></div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group"><label>Username:</label><input type="text" id="username" required></div>
                <div class="form-group"><label>Email:</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Password:</label><input type="password" id="password" required></div>
                <div class="form-group"><label>Role:</label><select id="role" required><option value="">Select</option><option value="view_only">View Only</option><option value="admin">Admin</option></select></div>
                <div class="form-group"><label><input type="checkbox" id="isActive" checked> Active</label></div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <div id="folderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Create Folder</h3><button class="close" onclick="hideModal('folderModal')">&times;</button></div>
            <form id="folderForm">
                <input type="hidden" id="folderId">
                <div class="form-group"><label>Name:</label><input type="text" id="folderName" required></div>
                <div class="form-group"><label>Path:</label><input type="text" id="folderPath" placeholder="/"></div>
                <div class="form-group"><label>Permission:</label><select id="permissionLevel" required><option value="">Select</option><option value="view_only">View Only</option><option value="admin">Admin</option></select></div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <div id="renameFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Rename</h3><button class="close" onclick="hideModal('renameFolderModal')">&times;</button></div>
            <form id="renameFolderForm">
                <input type="hidden" id="renameFolderId">
                <div class="form-group"><label>New Name:</label><input type="text" id="newFolderName" required></div>
                <button type="submit" class="btn btn-primary">Rename</button>
            </form>
        </div>
    </div>

    <div id="filesModal" class="files-modal">
        <div class="files-modal-content">
            <div class="modal-header"><h3 id="filesModalTitle">Files</h3><button class="close" onclick="hideModal('filesModal')">&times;</button></div>
            <div id="filesContent"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script>
        let selectedUsers=new Set(),selectedFolders=new Set(),selectedFiles=new Set(),folders=[],users=[],files=[];
        const h=()=>({'Authorization':`Bearer ${localStorage.getItem('adminToken')}`,'Content-Type':'application/json'});
        const esc=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML;};
        
        function logout(){localStorage.removeItem('adminToken');window.location.href='/login.html';}
        function showTab(n){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById(n).classList.add('active');event.target.classList.add('active');if(n==='users')loadUsers();else if(n==='folders')loadFolders();else if(n==='files')loadFiles();}
        function showModal(id){document.getElementById(id).style.display='block';}
        function hideModal(id){document.getElementById(id).style.display='none';if(id==='userModal'){document.getElementById('userForm').reset();document.getElementById('userId').value='';}}
        
        async function loadUsers(){try{const r=await fetch('/api/users',{headers:h()});if(!r.ok)throw new Error();users=await r.json();document.getElementById('userTableBody').innerHTML=users.map(u=>`<tr><td><input type="checkbox" value="${u.id}" onchange="toggleUserSelection(${u.id})"></td><td>${esc(u.username)}</td><td>${esc(u.email)}</td><td>${u.role==='admin'?'Admin':'View Only'}</td><td><span class="status ${u.isActive?'active':'inactive'}">${u.isActive?'Active':'Inactive'}</span></td><td><button class="btn btn-primary" onclick="editUser(${u.id})">Edit</button> <button class="btn btn-danger" onclick="deleteUser(${u.id})">Delete</button></td></tr>`).join('');}catch{showError('Failed to load users');}}
        
        function toggleUserSelection(id){selectedUsers.has(id)?selectedUsers.delete(id):selectedUsers.add(id);const i=document.getElementById('userSelectionInfo');i.style.display=selectedUsers.size>0?'block':'none';document.getElementById('userSelectionCount').textContent=selectedUsers.size;}
        function toggleSelectAllUsers(){const c=document.getElementById('selectAllUsers').checked;selectedUsers.clear();document.querySelectorAll('#userTableBody input[type="checkbox"]').forEach(cb=>{cb.checked=c;if(c)selectedUsers.add(parseInt(cb.value));});toggleUserSelection(0);}
        
        async function deleteSelectedUsers(){if(selectedUsers.size===0)return alert('Select users first');if(!confirm(`Delete ${selectedUsers.size} user(s)?`))return;let cnt=0;for(const id of selectedUsers){try{const r=await fetch(`/api/users/${id}`,{method:'DELETE',headers:h()});if(r.ok)cnt++;}catch{}}showSuccess(`Deleted ${cnt}`);selectedUsers.clear();loadUsers();}
        
        function editUser(id){const u=users.find(u=>u.id===id);if(!u)return;document.getElementById('userId').value=u.id;document.getElementById('username').value=u.username;document.getElementById('email').value=u.email;document.getElementById('role').value=u.role;document.getElementById('isActive').checked=u.isActive;document.getElementById('password').required=false;showModal('userModal');}
        
        async function deleteUser(id){if(!confirm('Delete?'))return;try{const r=await fetch(`/api/users/${id}`,{method:'DELETE',headers:h()});if(r.ok){showSuccess('Deleted');loadUsers();}else showError('Failed');}catch{showError('Failed');}}
        
        async function loadFolders(){try{const r=await fetch('/api/folders',{headers:h()});if(!r.ok)throw new Error();folders=await r.json();const tb=document.getElementById('folderTableBody');tb.innerHTML='';folders.forEach(f=>{const row=document.createElement('tr');row.innerHTML=`<td><input type="checkbox" value="${f.id}" onchange="toggleFolderSelection(${f.id})"></td><td>${esc(f.name)}</td><td>${esc(f.path||'/')}</td><td>${f.permissionLevel==='admin'?'Admin':'View Only'}</td><td><button class="btn btn-primary" data-id="${f.id}" data-action="view">View Files</button> <button class="btn btn-warning" data-id="${f.id}" data-action="rename">Rename</button> <button class="btn btn-danger" data-id="${f.id}" data-action="delete">Delete</button></td>`;tb.appendChild(row);row.querySelectorAll('button').forEach(btn=>{btn.onclick=()=>{const id=parseInt(btn.dataset.id);const folder=folders.find(f=>f.id===id);if(btn.dataset.action==='view')viewEditFiles(id,folder.name);else if(btn.dataset.action==='rename')renameFolder(id,folder.name);else deleteFolder(id);};});});}catch{showError('Failed to load folders');}}
        
        function toggleFolderSelection(id){selectedFolders.has(id)?selectedFolders.delete(id):selectedFolders.add(id);const i=document.getElementById('folderSelectionInfo');i.style.display=selectedFolders.size>0?'block':'none';document.getElementById('folderSelectionCount').textContent=selectedFolders.size;}
        function toggleSelectAllFolders(){const c=document.getElementById('selectAllFolders').checked;selectedFolders.clear();document.querySelectorAll('#folderTableBody input[type="checkbox"]').forEach(cb=>{cb.checked=c;if(c)selectedFolders.add(parseInt(cb.value));});toggleFolderSelection(0);}
        
        async function deleteSelectedFolders(){if(selectedFolders.size===0)return alert('Select folders');if(!confirm(`Delete ${selectedFolders.size} folder(s)?`))return;let cnt=0;for(const id of selectedFolders){try{const r=await fetch(`/api/folders/${id}`,{method:'DELETE',headers:h()});if(r.ok)cnt++;}catch{}}showSuccess(`Deleted ${cnt}`);selectedFolders.clear();loadFolders();}
        
        async function deleteFolder(id){if(!confirm('Delete?'))return;try{const r=await fetch(`/api/folders/${id}`,{method:'DELETE',headers:h()});if(r.ok){showSuccess('Deleted');loadFolders();}else showError('Failed');}catch{showError('Failed');}}
        
        function renameFolder(id,name){document.getElementById('renameFolderId').value=id;document.getElementById('newFolderName').value=name;showModal('renameFolderModal');}
        
        async function viewEditFiles(folderId,folderName){document.getElementById('filesModalTitle').textContent=`Files: ${folderName}`;showModal('filesModal');const c=document.getElementById('filesContent');c.innerHTML='<div class="loading">Loading...</div>';try{const r=await fetch(`/api/folders/${folderId}/files`,{headers:h()});if(!r.ok)throw new Error();const d=await r.json();if(d.files&&d.files.length>0){c.innerHTML=`<table class="table"><thead><tr><th>File</th><th>Size</th><th>Date</th><th>Actions</th></tr></thead><tbody>${d.files.map(f=>`<tr><td>${esc(f.name)}</td><td>${formatFileSize(f.size)}</td><td>${formatDate(f.uploaded_at)}</td><td><button class="btn btn-primary" onclick="viewFile(${f.id})">View</button> <button class="btn btn-danger" onclick="deleteFileFromModal(${f.id},${folderId},'${esc(folderName).replace(/'/g,"\\'")}')">Delete</button></td></tr>`).join('')}</tbody></table>`;}else{c.innerHTML='<div class="loading">No files</div>';}}catch{c.innerHTML='<div class="error-message">Error</div>';}}
        
        async function deleteFileFromModal(fileId,folderId,folderName){if(!confirm('Delete?'))return;try{const r=await fetch(`/api/files/${fileId}`,{method:'DELETE',headers:h()});if(r.ok){showSuccess('Deleted');viewEditFiles(folderId,folderName);}else showError('Failed');}catch{showError('Failed');}}
        
        async function loadFiles(){try{const r=await fetch('/api/files',{headers:h()});if(!r.ok)throw new Error();files=await r.json();document.getElementById('fileTableBody').innerHTML=files.map(f=>`<tr><td><input type="checkbox" value="${f.id}" onchange="toggleFileSelection(${f.id})"></td><td>${esc(f.name)}</td><td>${esc(f.folderName||'N/A')}</td><td>${formatFileSize(f.size)}</td><td><button class="btn btn-primary" onclick="viewFile(${f.id})">View</button> <button class="btn btn-danger" onclick="deleteFile(${f.id})">Delete</button></td></tr>`).join('');}catch{showError('Failed');}}
        
        function toggleFileSelection(id){selectedFiles.has(id)?selectedFiles.delete(id):selectedFiles.add(id);const i=document.getElementById('fileSelectionInfo');i.style.display=selectedFiles.size>0?'block':'none';document.getElementById('fileSelectionCount').textContent=selectedFiles.size;}
        function toggleSelectAllFiles(){const c=document.getElementById('selectAllFiles').checked;selectedFiles.clear();document.querySelectorAll('#fileTableBody input[type="checkbox"]').forEach(cb=>{cb.checked=c;if(c)selectedFiles.add(parseInt(cb.value));});toggleFileSelection(0);}
        
        async function deleteSelectedFiles(){if(selectedFiles.size===0)return alert('Select files');if(!confirm(`Delete ${selectedFiles.size}?`))return;let cnt=0;for(const id of selectedFiles){try{const r=await fetch(`/api/files/${id}`,{method:'DELETE',headers:h()});if(r.ok)cnt++;}catch{}}showSuccess(`Deleted ${cnt}`);selectedFiles.clear();loadFiles();}
        
        async function deleteFile(id){if(!confirm('Delete?'))return;try{const r=await fetch(`/api/files/${id}`,{method:'DELETE',headers:h()});if(r.ok){showSuccess('Deleted');loadFiles();}else showError('Failed');}catch{showError('Failed');}}
        
        function viewFile(id){window.open(`/api/files/${id}/view`,'_blank');}
        
        document.getElementById('userForm').onsubmit=async(e)=>{e.preventDefault();const d={username:document.getElementById('username').value,email:document.getElementById('email').value,role:document.getElementById('role').value,isActive:document.getElementById('isActive').checked};const p=document.getElementById('password').value;if(p)d.password=p;const id=document.getElementById('userId').value;try{const r=await fetch(`/api/users${id?'/'+id:''}`,{method:id?'PUT':'POST',headers:h(),body:JSON.stringify(d)});if(r.ok){showSuccess('Saved');hideModal('userModal');loadUsers();}else showError('Failed');}catch{showError('Failed');}};
        
        document.getElementById('folderForm').onsubmit=async(e)=>{e.preventDefault();const d={name:document.getElementById('folderName').value,path:document.getElementById('folderPath').value||'/',permissionLevel:document.getElementById('permissionLevel').value};const id=document.getElementById('folderId').value;try{const r=await fetch(`/api/folders${id?'/'+id:''}`,{method:id?'PUT':'POST',headers:h(),body:JSON.stringify(d)});if(r.ok){showSuccess('Saved');hideModal('folderModal');loadFolders();}else showError('Failed');}catch{showError('Failed');}};
        
        document.getElementById('renameFolderForm').onsubmit=async(e)=>{e.preventDefault();const id=document.getElementById('renameFolderId').value;const name=document.getElementById('newFolderName').value;try{const r=await fetch(`/api/folders/${id}/rename`,{method:'PUT',headers:h(),body:JSON.stringify({name})});if(r.ok){showSuccess('Renamed');hideModal('renameFolderModal');loadFolders();}else showError('Failed');}catch{showError('Failed');}};
        
        function formatFileSize(b){if(!b)return '0 B';const k=1024,s=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(k));return(b/Math.pow(k,i)).toFixed(2)+' '+s[i];}
        function formatDate(d){if(!d)return 'N/A';try{return new Date(d).toLocaleDateString();}catch{return 'N/A';}}
        function showError(m){const d=document.createElement('div');d.className='error-message';d.textContent=m;document.querySelector('.container').insertBefore(d,document.querySelector('.container').firstChild);setTimeout(()=>d.remove(),5000);}
        function showSuccess(m){const d=document.createElement('div');d.className='success-message';d.textContent=m;document.querySelector('.container').insertBefore(d,document.querySelector('.container').firstChild);setTimeout(()=>d.remove(),5000);}
        
        document.addEventListener('DOMContentLoaded',()=>{loadUsers();window.addEventListener('click',e=>{if(e.target.classList.contains('modal')||e.target.classList.contains('files-modal'))e.target.style.display='none';});});
    </script>
</body>
</html>
