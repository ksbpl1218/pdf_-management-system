<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PDF Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .header { background-color: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .logout-btn { background-color: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .logout-btn:hover { background-color: #c0392b; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .tabs { display: flex; background: white; border-radius: 8px 8px 0 0; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab { padding: 1rem 2rem; background-color: #ecf0f1; border: none; cursor: pointer; font-size: 1rem; flex: 1; text-align: center; }
        .tab.active { background-color: #3498db; color: white; }
        .tab:hover:not(.active) { background-color: #d5dbdb; }
        .tab-content { display: none; background: white; padding: 2rem; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 400px; }
        .tab-content.active { display: block; }
        .actions { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #c0392b; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-warning:hover:not(:disabled) { background-color: #e67e22; }
        .btn-success { background-color: #27ae60; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #229954; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .table th { background-color: #34495e; color: white; font-weight: 600; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 3% auto; padding: 2rem; border-radius: 8px; max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #ecf0f1; }
        .modal-header h3 { color: #2c3e50; font-size: 1.5rem; }
        .close { background: none; border: none; font-size: 2rem; cursor: pointer; color: #7f8c8d; line-height: 1; }
        .close:hover { color: #e74c3c; }
        .status { padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
        .status.active { background-color: #d5e8d4; color: #27ae60; }
        .status.inactive { background-color: #f8d7da; color: #e74c3c; }
        .selection-info { background-color: #e3f2fd; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem; color: #1976d2; font-weight: 600; }
        .error-message, .success-message { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; animation: slideIn 0.3s; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { text-align: center; padding: 3rem; color: #7f8c8d; font-size: 1.1rem; }
        .loading::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .file-upload-area { border: 2px dashed #bdc3c7; border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1rem; transition: all 0.3s; }
        .file-upload-area:hover { border-color: #3498db; background-color: #f8f9fa; }
        .file-upload-area.drag-over { border-color: #3498db; background-color: #e3f2fd; }
        .file-list { margin-top: 1rem; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem; }
        .action-buttons { display: flex; gap: 0.5rem; }
    </style>
</head>
<body>
    <script>
        // Check authentication before page loads
        if (!localStorage.getItem('adminToken')) {
            window.location.href = '/login.html';
        }
    </script>

    <div class="header">
        <h1>PDF Management System - Admin Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('users')">Users</button>
            <button class="tab" onclick="showTab('folders')">Folders</button>
            <button class="tab" onclick="showTab('files')">Files</button>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content active">
            <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">User Management</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="showAddUserModal()">Add User</button>
                <button class="btn btn-danger" onclick="deleteSelectedUsers()">Delete Selected</button>
            </div>
            <div id="userSelectionInfo" class="selection-info" style="display:none;">
                <span id="userSelectionCount">0</span> user(s) selected
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()"></th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="6" class="loading">Loading users</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Folders Tab -->
        <div id="folders" class="tab-content">
            <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">Folder Management</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="showAddFolderModal()">Create Folder</button>
                <button class="btn btn-danger" onclick="deleteSelectedFolders()">Delete Selected</button>
            </div>
            <div id="folderSelectionInfo" class="selection-info" style="display:none;">
                <span id="folderSelectionCount">0</span> folder(s) selected
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAllFolders" onchange="toggleSelectAllFolders()"></th>
                            <th>Name</th>
                            <th>Path</th>
                            <th>Permission</th>
                            <th>Files</th>
                            <th style="width: 300px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="folderTableBody">
                        <tr><td colspan="6" class="loading">Loading folders</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Files Tab -->
        <div id="files" class="tab-content">
            <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">File Management</h2>
            <div class="actions">
                <button class="btn btn-danger" onclick="deleteSelectedFiles()">Delete Selected</button>
            </div>
            <div id="fileSelectionInfo" class="selection-info" style="display:none;">
                <span id="fileSelectionCount">0</span> file(s) selected
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAllFiles" onchange="toggleSelectAllFiles()"></th>
                            <th>Name</th>
                            <th>Folder</th>
                            <th>Size</th>
                            <th>Uploaded</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody">
                        <tr><td colspan="6" class="loading">Loading files</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="close" onclick="hideModal('userModal')">&times;</button>
            </div>
            <form id="userForm" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Password <span id="passwordOptional" style="display:none; color: #7f8c8d;">(leave blank to keep current)</span></label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="view_only">View Only</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="isActive" checked style="width: auto; margin-right: 0.5rem;">
                        Active Account
                    </label>
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-primary">Save User</button>
                    <button type="button" class="btn" onclick="hideModal('userModal')" style="background: #95a5a6; color: white;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="folderModalTitle">Create Folder</h3>
                <button class="close" onclick="hideModal('folderModal')">&times;</button>
            </div>
            <form id="folderForm" onsubmit="handleFolderSubmit(event)">
                <input type="hidden" id="folderId">
                <div class="form-group">
                    <label>Folder Name *</label>
                    <input type="text" id="folderName" required placeholder="Enter folder name">
                </div>
                <div class="form-group">
                    <label>Path</label>
                    <input type="text" id="folderPath" placeholder="/" value="/">
                </div>
                <div class="form-group">
                    <label>Permission Level *</label>
                    <select id="permissionLevel" required>
                        <option value="">Select Permission</option>
                        <option value="view_only">View Only</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-primary">Save Folder</button>
                    <button type="button" class="btn" onclick="hideModal('folderModal')" style="background: #95a5a6; color: white;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Folder Modal -->
    <div id="renameFolderModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Rename Folder</h3>
                <button class="close" onclick="hideModal('renameFolderModal')">&times;</button>
            </div>
            <form id="renameFolderForm" onsubmit="handleRenameFolder(event)">
                <input type="hidden" id="renameFolderId">
                <div class="form-group">
                    <label>New Folder Name *</label>
                    <input type="text" id="newFolderName" required placeholder="Enter new name">
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-primary">Rename</button>
                    <button type="button" class="btn" onclick="hideModal('renameFolderModal')" style="background: #95a5a6; color: white;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Files Modal -->
    <div id="uploadFilesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Files to: <span id="uploadFolderName" style="color: #3498db;"></span></h3>
                <button class="close" onclick="hideModal('uploadFilesModal')">&times;</button>
            </div>
            <input type="hidden" id="uploadFolderId">
            <div class="file-upload-area" id="fileUploadArea">
                <p style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 1rem;">Drag and drop PDF files here</p>
                <p style="color: #95a5a6; margin-bottom: 1rem;">or</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
            </div>
            <div id="selectedFilesList" class="file-list"></div>
            <div class="actions">
                <button type="button" class="btn btn-success" onclick="uploadFiles()" id="uploadBtn" disabled>Upload Files</button>
                <button type="button" class="btn" onclick="hideModal('uploadFilesModal')" style="background: #95a5a6; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Files Modal -->
    <div id="viewFilesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Files in: <span id="viewFolderName" style="color: #3498db;"></span></h3>
                <button class="close" onclick="hideModal('viewFilesModal')">&times;</button>
            </div>
            <div id="viewFilesContent">
                <div class="loading">Loading files</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let selectedUsers = new Set();
        let selectedFolders = new Set();
        let selectedFiles = new Set();
        let users = [];
        let folders = [];
        let files = [];
        let selectedFilesToUpload = [];

        // Token management
        const getToken = () => localStorage.getItem('adminToken');
        const getHeaders = () => ({
            'Authorization': `Bearer ${getToken()}`,
            'Content-Type': 'application/json'
        });

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminToken');
                window.location.href = '/login.html';
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'users') loadUsers();
            else if (tabName === 'folders') loadFolders();
            else if (tabName === 'files') loadFiles();
        }

        function showModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'userModal') {
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('password').required = true;
                document.getElementById('passwordOptional').style.display = 'none';
            } else if (id === 'folderModal') {
                document.getElementById('folderForm').reset();
                document.getElementById('folderId').value = '';
            } else if (id === 'uploadFilesModal') {
                selectedFilesToUpload = [];
                document.getElementById('selectedFilesList').innerHTML = '';
                document.getElementById('uploadBtn').disabled = true;
            }
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.container').firstChild);
            setTimeout(() => div.remove(), 5000);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.container').firstChild);
            setTimeout(() => div.remove(), 5000);
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleString();
            } catch (e) {
                return 'N/A';
            }
        }

        // USER MANAGEMENT
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', { headers: getHeaders() });
                if (!response.ok) throw new Error('Failed to load users');
                users = await response.json();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users');
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #7f8c8d;">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><input type="checkbox" value="${u.id}" ${selectedUsers.has(u.id) ? 'checked' : ''} onchange="toggleUserSelection(${u.id})"></td>
                    <td>${escapeHtml(u.username)}</td>
                    <td>${escapeHtml(u.email)}</td>
                    <td>${u.role === 'admin' ? 'Admin' : 'View Only'}</td>
                    <td><span class="status ${u.isActive ? 'active' : 'inactive'}">${u.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="showUploadModal(${f.id}, '${escapeHtml(f.name).replace(/'/g, "\\'")}')">Upload</button>
                        <button class="btn btn-success btn-sm" onclick="viewFolderFiles(${f.id}, '${escapeHtml(f.name).replace(/'/g, "\\'")}')">View Files</button>
                        <button class="btn btn-warning btn-sm" onclick="showRenameModal(${f.id}, '${escapeHtml(f.name).replace(/'/g, "\\'")}')">Rename</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFolder(${f.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleFolderSelection(id) {
            selectedFolders.has(id) ? selectedFolders.delete(id) : selectedFolders.add(id);
            updateFolderSelectionInfo();
        }

        function toggleSelectAllFolders() {
            const checked = document.getElementById('selectAllFolders').checked;
            selectedFolders.clear();
            if (checked) {
                folders.forEach(f => selectedFolders.add(f.id));
            }
            updateFolderSelectionInfo();
            renderFolders();
        }

        function updateFolderSelectionInfo() {
            const info = document.getElementById('folderSelectionInfo');
            info.style.display = selectedFolders.size > 0 ? 'block' : 'none';
            document.getElementById('folderSelectionCount').textContent = selectedFolders.size;
        }

        function showAddFolderModal() {
            document.getElementById('folderModalTitle').textContent = 'Create Folder';
            document.getElementById('folderForm').reset();
            document.getElementById('folderId').value = '';
            document.getElementById('folderPath').value = '/';
            showModal('folderModal');
        }

        async function handleFolderSubmit(event) {
            event.preventDefault();
            
            const folderId = document.getElementById('folderId').value;
            const data = {
                name: document.getElementById('folderName').value,
                path: document.getElementById('folderPath').value || '/',
                permissionLevel: document.getElementById('permissionLevel').value
            };
            
            try {
                const url = folderId ? `/api/folders/${folderId}` : '/api/folders';
                const method = folderId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSuccess(folderId ? 'Folder updated successfully' : 'Folder created successfully');
                    hideModal('folderModal');
                    loadFolders();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to save folder');
                }
            } catch (error) {
                console.error('Error saving folder:', error);
                showError('Failed to save folder');
            }
        }

        function showRenameModal(folderId, folderName) {
            document.getElementById('renameFolderId').value = folderId;
            document.getElementById('newFolderName').value = folderName;
            showModal('renameFolderModal');
        }

        async function handleRenameFolder(event) {
            event.preventDefault();
            
            const folderId = document.getElementById('renameFolderId').value;
            const newName = document.getElementById('newFolderName').value;
            
            try {
                const response = await fetch(`/api/folders/${folderId}/rename`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ name: newName })
                });
                
                if (response.ok) {
                    showSuccess('Folder renamed successfully');
                    hideModal('renameFolderModal');
                    loadFolders();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to rename folder');
                }
            } catch (error) {
                console.error('Error renaming folder:', error);
                showError('Failed to rename folder');
            }
        }

        async function deleteFolder(id) {
            const folder = folders.find(f => f.id === id);
            const fileCount = folder ? folder.file_count : 0;
            
            let message = 'Are you sure you want to delete this folder?';
            if (fileCount > 0) {
                message += `\n\nThis will also delete ${fileCount} file(s) in this folder.`;
            }
            
            if (!confirm(message)) return;
            
            try {
                const response = await fetch(`/api/folders/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showSuccess('Folder deleted successfully');
                    selectedFolders.delete(id);
                    loadFolders();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to delete folder');
                }
            } catch (error) {
                console.error('Error deleting folder:', error);
                showError('Failed to delete folder');
            }
        }

        async function deleteSelectedFolders() {
            if (selectedFolders.size === 0) {
                alert('Please select folders to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedFolders.size} folder(s) and all their files?`)) return;
            
            let successCount = 0;
            for (const id of selectedFolders) {
                try {
                    const response = await fetch(`/api/folders/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });
                    if (response.ok) successCount++;
                } catch (error) {
                    console.error('Error deleting folder:', error);
                }
            }
            
            showSuccess(`Deleted ${successCount} folder(s)`);
            selectedFolders.clear();
            loadFolders();
        }

        // FILE UPLOAD
        function showUploadModal(folderId, folderName) {
            document.getElementById('uploadFolderId').value = folderId;
            document.getElementById('uploadFolderName').textContent = folderName;
            selectedFilesToUpload = [];
            document.getElementById('selectedFilesList').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
            showModal('uploadFilesModal');
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToUpload(files);
        }

        function addFilesToUpload(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    selectedFilesToUpload.push(file);
                }
            });
            renderSelectedFiles();
        }

        function renderSelectedFiles() {
            const container = document.getElementById('selectedFilesList');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (selectedFilesToUpload.length === 0) {
                container.innerHTML = '';
                uploadBtn.disabled = true;
                return;
            }
            
            uploadBtn.disabled = false;
            container.innerHTML = '<h4 style="margin-bottom: 1rem; color: #2c3e50;">Selected Files:</h4>' +
                selectedFilesToUpload.map((file, index) => `
                    <div class="file-item">
                        <div>
                            <strong>${escapeHtml(file.name)}</strong>
                            <span style="color: #7f8c8d; margin-left: 1rem;">${formatFileSize(file.size)}</span>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeFileFromUpload(${index})">Remove</button>
                    </div>
                `).join('');
        }

        function removeFileFromUpload(index) {
            selectedFilesToUpload.splice(index, 1);
            renderSelectedFiles();
        }

        async function uploadFiles() {
            if (selectedFilesToUpload.length === 0) return;
            
            const folderId = document.getElementById('uploadFolderId').value;
            const formData = new FormData();
            formData.append('folderId', folderId);
            
            selectedFilesToUpload.forEach(file => {
                formData.append('files', file);
            });
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            try {
                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess(result.message || 'Files uploaded successfully');
                    hideModal('uploadFilesModal');
                    loadFolders();
                    loadFiles();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to upload files');
                }
            } catch (error) {
                console.error('Error uploading files:', error);
                showError('Failed to upload files');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Files';
            }
        }

        // Drag and drop
        const uploadArea = document.getElementById('fileUploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                addFilesToUpload(files);
            });
        }

        // VIEW FOLDER FILES
        async function viewFolderFiles(folderId, folderName) {
            document.getElementById('viewFolderName').textContent = folderName;
            showModal('viewFilesModal');
            
            const content = document.getElementById('viewFilesContent');
            content.innerHTML = '<div class="loading">Loading files</div>';
            
            try {
                const response = await fetch(`/api/folders/${folderId}/files`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load files');
                
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    content.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Uploaded</th>
                                        <th style="width: 200px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.files.map(f => `
                                        <tr>
                                            <td>${escapeHtml(f.name)}</td>
                                            <td>${formatFileSize(f.size)}</td>
                                            <td>${formatDate(f.uploaded_at)}</td>
                                            <td class="action-buttons">
                                                <button class="btn btn-primary btn-sm" onclick="viewFile(${f.id})">View</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteFileFromModal(${f.id}, ${folderId}, '${escapeHtml(folderName).replace(/'/g, "\\'")}')">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">No files in this folder</div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                content.innerHTML = '<div class="error-message">Failed to load files</div>';
            }
        }

        async function deleteFileFromModal(fileId, folderId, folderName) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showSuccess('File deleted successfully');
                    viewFolderFiles(folderId, folderName);
                    loadFolders();
                    loadFiles();
                } else {
                    showError('Failed to delete file');
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                showError('Failed to delete file');
            }
        }

        // FILE MANAGEMENT
        async function loadFiles() {
            try {
                const response = await fetch('/api/files', { headers: getHeaders() });
                if (!response.ok) throw new Error('Failed to load files');
                files = await response.json();
                renderFiles();
            } catch (error) {
                console.error('Error loading files:', error);
                showError('Failed to load files');
            }
        }

        function renderFiles() {
            const tbody = document.getElementById('fileTableBody');
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #7f8c8d;">No files found</td></tr>';
                return;
            }
            tbody.innerHTML = files.map(f => `
                <tr>
                    <td><input type="checkbox" value="${f.id}" ${selectedFiles.has(f.id) ? 'checked' : ''} onchange="toggleFileSelection(${f.id})"></td>
                    <td>${escapeHtml(f.name)}</td>
                    <td>${escapeHtml(f.folderName || 'N/A')}</td>
                    <td>${formatFileSize(f.size)}</td>
                    <td>${formatDate(f.uploaded_at)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="viewFile(${f.id})">View</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFile(${f.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleFileSelection(id) {
            selectedFiles.has(id) ? selectedFiles.delete(id) : selectedFiles.add(id);
            updateFileSelectionInfo();
        }

        function toggleSelectAllFiles() {
            const checked = document.getElementById('selectAllFiles').checked;
            selectedFiles.clear();
            if (checked) {
                files.forEach(f => selectedFiles.add(f.id));
            }
            updateFileSelectionInfo();
            renderFiles();
        }

        function updateFileSelectionInfo() {
            const info = document.getElementById('fileSelectionInfo');
            info.style.display = selectedFiles.size > 0 ? 'block' : 'none';
            document.getElementById('fileSelectionCount').textContent = selectedFiles.size;
        }

        function viewFile(fileId) {
            window.open(`/api/files/${fileId}/view`, '_blank');
        }

        async function deleteFile(id) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            try {
                const response = await fetch(`/api/files/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showSuccess('File deleted successfully');
                    selectedFiles.delete(id);
                    loadFiles();
                    loadFolders();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to delete file');
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                showError('Failed to delete file');
            }
        }

        async function deleteSelectedFiles() {
            if (selectedFiles.size === 0) {
                alert('Please select files to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedFiles.size} file(s)?`)) return;
            
            let successCount = 0;
            for (const id of selectedFiles) {
                try {
                    const response = await fetch(`/api/files/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });
                    if (response.ok) successCount++;
                } catch (error) {
                    console.error('Error deleting file:', error);
                }
            }
            
            showSuccess(`Deleted ${successCount} file(s)`);
            selectedFiles.clear();
            loadFiles();
            loadFolders();
        }

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
    </script>
</body>
</html>sm" onclick="editUser(${u.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleUserSelection(id) {
            selectedUsers.has(id) ? selectedUsers.delete(id) : selectedUsers.add(id);
            updateUserSelectionInfo();
        }

        function toggleSelectAllUsers() {
            const checked = document.getElementById('selectAllUsers').checked;
            selectedUsers.clear();
            if (checked) {
                users.forEach(u => selectedUsers.add(u.id));
            }
            updateUserSelectionInfo();
            renderUsers();
        }

        function updateUserSelectionInfo() {
            const info = document.getElementById('userSelectionInfo');
            info.style.display = selectedUsers.size > 0 ? 'block' : 'none';
            document.getElementById('userSelectionCount').textContent = selectedUsers.size;
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('passwordOptional').style.display = 'none';
            showModal('userModal');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('role').value = user.role;
            document.getElementById('isActive').checked = user.isActive;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false;
            document.getElementById('passwordOptional').style.display = 'inline';
            showModal('userModal');
        }

        async function handleUserSubmit(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value,
                isActive: document.getElementById('isActive').checked
            };
            
            const password = document.getElementById('password').value;
            if (password) data.password = password;
            
            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSuccess(userId ? 'User updated successfully' : 'User created successfully');
                    hideModal('userModal');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to save user');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showError('Failed to save user');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    showSuccess('User deleted successfully');
                    selectedUsers.delete(id);
                    loadUsers();
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
            }
        }

        async function deleteSelectedUsers() {
            if (selectedUsers.size === 0) {
                alert('Please select users to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedUsers.size} user(s)?`)) return;
            
            let successCount = 0;
            for (const id of selectedUsers) {
                try {
                    const response = await fetch(`/api/users/${id}`, {
                        method: 'DELETE',
                        headers: getHeaders()
                    });
                    if (response.ok) successCount++;
                } catch (error) {
                    console.error('Error deleting user:', error);
                }
            }
            
            showSuccess(`Deleted ${successCount} user(s)`);
            selectedUsers.clear();
            loadUsers();
        }

        // FOLDER MANAGEMENT
        async function loadFolders() {
            try {
                const response = await fetch('/api/folders', { headers: getHeaders() });
                if (!response.ok) throw new Error('Failed to load folders');
                folders = await response.json();
                renderFolders();
            } catch (error) {
                console.error('Error loading folders:', error);
                showError('Failed to load folders');
            }
        }

        function renderFolders() {
            const tbody = document.getElementById('folderTableBody');
            if (folders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #7f8c8d;">No folders found</td></tr>';
                return;
            }
            tbody.innerHTML = folders.map(f => `
                <tr>
                    <td><input type="checkbox" value="${f.id}" ${selectedFolders.has(f.id) ? 'checked' : ''} onchange="toggleFolderSelection(${f.id})"></td>
                    <td>${escapeHtml(f.name)}</td>
                    <td>${escapeHtml(f.path || '/')}</td>
                    <td>${f.permissionLevel === 'admin' ? 'Admin' : 'View Only'}</td>
                    <td>${f.file_count || 0}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-
